# Описание работы пайплайна CI/CD

### Стадия сборки (build)

Эта стадия отвечает за сборку проекта. Она выполняется в контейнере на основе образа `mcr.microsoft.com/dotnet/sdk:9.0`.

1. **Восстановление зависимостей**: Выполняется команда `dotnet restore`, чтобы восстановить все необходимые пакеты и зависимости проекта.
2. **Сборка проекта**: Выполняется команда `dotnet build`, чтобы собрать проект в конфигурации `Release`. Флаг `--no-restore` указывает, что зависимости уже восстановлены на предыдущем шаге.

После сборки артефакты сохраняются в каталоге `$PROJECT_NAME/bin/$BUILD_CONFIGURATION/net9.0/` и сохраняются на неделю.

### Стадия тестирования (test)

Эта стадия закомментирована, но если она будет активирована, она будет отвечать за запуск юнит-тестов проекта.

1. **Запуск юнит-тестов**: Выполняется команда `dotnet test`, чтобы запустить все юнит-тесты проекта в конфигурации `Release`. Флаг `--no-build` указывает, что проект уже собран на предыдущей стадии.

Эта стадия зависит от стадии сборки, то есть она запускается только после успешной сборки проекта.

### Стадия интеграционного тестирования (integration-test)

Эта стадия также закомментирована, но если она будет активирована, она будет отвечать за запуск интеграционных тестов проекта.

1. **Настройка окружения**: В этой стадии используется образ `mcr.microsoft.com/dotnet/sdk:9.0` и сервис `docker:dind`, чтобы обеспечить возможность запуска Docker внутри Docker.
2. **Установка необходимых пакетов**: Выполняются команды для установки Docker и его зависимостей на хосте.
3. **Запуск интеграционных тестов**: Выполняется команда `dotnet test`, чтобы запустить интеграционные тесты проекта в конфигурации `Release`.

Эта стадия зависит от стадии тестирования, то есть она запускается только после успешного прохождения юнит-тестов.

### Стадия публикации (publish)

Эта стадия отвечает за публикацию образа Docker проекта.

1. **Вход в Docker Hub**: Выполняется команда `docker login`, чтобы войти в Docker Hub с помощью учетных данных из переменных окружения.
2. **Сборка и публикация образа**: Выполняется команда `docker build`, чтобы собрать образ проекта на основе Dockerfile в каталоге `Prod`. Затем выполняется команда `docker push`, чтобы опубликовать образ в Docker Hub.

### Стадия развертывания (deploy)

Эта стадия отвечает за развертывание проекта на удаленном сервере.

1. **Подготовка SSH-ключа**: Создается каталог `~/.ssh`, и в него копируется приватный SSH-ключ из переменной окружения.
2. **Настройка SSH-агента**: Добавляется ключ в SSH-агент для аутентификации на удаленном сервере.
3. **Копирование файлов на сервер**: Копируются файлы `compose.yaml`, `prometheus.yml`, каталоги `grafana` и `elasticsearch` на удаленный сервер.
4. **Развертывание контейнеров**: Выполняется команда `docker compose`, чтобы остановить существующие контейнеры, обновить образы, и запустить контейнеры в фоновом режиме.

Эта стадия использует переменные окружения для подключения к серверу по SSH.
